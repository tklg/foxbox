/* global Log Passport boxes */
const passport = require('passport')
const GoogleStrategy = require('passport-google-oauth20').Strategy
const TAG = 'ProviderController'

passport.use(new GoogleStrategy({
  clientID: process.env.GOOGLE_CLIENT_ID,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET,
  callbackURL: process.env.ROOT_URL + '/connect/google/callback',
  passReqToCallback: true
}, async function (req, accessToken, refreshToken, profile, cb) {
  Log.d(TAG, profile)
  const pass = await Passport.findOrCreate({ provider: 'google', identifier: profile.id, user: req.user })

  if (accessToken) pass.accessToken = accessToken
  if (refreshToken) pass.refreshToken = refreshToken
  if (profile.emails && profile.emails.length) pass.email = profile.emails[0].value
  if (accessToken || refreshToken) await pass.save()

  cb(null, pass, profile, null)
}))

module.exports = {
  list: async (req, res) => {
    const { hash } = await boxes.helpers.hashids()
    const connected = await Passport.where({ user: req.user })
    res.json({
      available: [{
        name: 'Gmail',
        icon: 'gmail'
      }, {
        name: 'Outlook',
        icon: 'outlook'
      }, {
        name: 'Other',
        icon: 'at'
      }],
      connected: connected.filter(x => x.provider !== 'auth3').map(x => {
        let name = x.provider
        let icon = x.provider
        switch (x.provider) {
          case 'google': name = 'Gmail'; icon = 'gmail'; break
        }
        return {
          id: hash(x.id),
          name,
          icon,
          address: x.email
        }
      })
    })
  },
  connect: async (req, res, next) => {
    let provider = req.params.provider
    if (provider === 'gmail') provider = 'google'
    let scope
    switch (provider) {
      case 'google': scope = [ 'profile', 'email', 'https://mail.google.com/' ]
    }
    passport.authorize(provider, { scope: scope })(req, res, next)
  },
  connectCallback: async (req, res, next) => {
    let provider = req.params.provider
    if (provider === 'gmail') provider = 'google'
    passport.authorize(provider, async (e, pass, info, status) => {
      if (e) {
        Log.e(TAG, e)
      }

      const user = req.user
      pass.user = user
      await pass.save()

      if (process.env.NODE_ENV === 'development') return res.redirect('http://localhost:3000/box')
      res.redirect('/box')
    })(req, res, next)
  },
  listMailboxes: async (req, res) => {
    const { clientBuilder, providerOpts } = await boxes.helpers.imap()
    const { unhash } = await boxes.helpers.hashids()
    const passport = await Passport.findOne({ id: unhash(req.params.id) })

    /* const client = await clientBuilder({
      ...providerOpts[passport.provider],
      auth: {
        user: passport.email,
        xoauth2: passport.accessToken
      }
    })

    const mailboxes = await client.listMailboxes() */

    function setDisplayName (items) {
      for (let i in items) {
        const name = items[i].name
        if (/^[A-Z]+$/.test(name)) {
          items[i].displayName = name[0].toUpperCase() + name.substr(1).toLowerCase()
        } else {
          items[i].displayName = name
        }
        if (items[i].children) setDisplayName(items[i].children)
      }
    }

    function strip (items) {
      for (let i in items) {
        const item = items[i]
        items[i] = {
          name: item.name,
          children: item.children,
          path: item.path
        }
        if (items[i].children) strip(items[i].children)
      }
    }

    async function setMessageCounts (items) {
      for (let i in items) {
        if (!items[i].children || !items[i].children.length) {
          if (!items[i].path.startsWith('[Gmail]')) {
            const box = await client.selectMailbox(items[i].path)
            items[i].messageCount = box.exists
            items[i].highestModseq = box.highestModseq
          }
        }
        if (items[i].children) setMessageCounts(items[i].children)
      }
    }

    // strip(mailboxes.children)
    // setDisplayName(mailboxes.children)
    // await setMessageCounts(mailboxes.children)
    const mailboxes = { children: [{ 'name': 'INBOX', 'children': [], 'path': 'INBOX', 'displayName': 'Inbox', 'messageCount': 614, 'highestModseq': '3674713' }, { 'name': 'Personal', 'children': [{ 'name': 'Daily UI', 'children': [], 'path': 'Personal/Daily UI', 'displayName': 'Daily UI', 'messageCount': 121, 'highestModseq': '3674713' }], 'path': 'Personal', 'displayName': 'Personal' }, { 'name': 'Receipts', 'children': [], 'path': 'Receipts', 'displayName': 'Receipts', 'messageCount': 2, 'highestModseq': '3674713' }, { 'name': 'Travel', 'children': [], 'path': 'Travel', 'displayName': 'Travel', 'messageCount': 0, 'highestModseq': '3674713' }, { 'name': 'Work', 'children': [], 'path': 'Work', 'displayName': 'Work', 'messageCount': 54, 'highestModseq': '3674713' }, { 'name': '[Gmail]', 'children': [{ 'name': 'All Mail', 'children': [], 'path': '[Gmail]/All Mail', 'displayName': 'All Mail' }, { 'name': 'Drafts', 'children': [], 'path': '[Gmail]/Drafts', 'displayName': 'Drafts' }, { 'name': 'Important', 'children': [], 'path': '[Gmail]/Important', 'displayName': 'Important' }, { 'name': 'Sent Mail', 'children': [], 'path': '[Gmail]/Sent Mail', 'displayName': 'Sent Mail' }, { 'name': 'Spam', 'children': [], 'path': '[Gmail]/Spam', 'displayName': 'Spam' }, { 'name': 'Starred', 'children': [], 'path': '[Gmail]/Starred', 'displayName': 'Starred' }, { 'name': 'Trash', 'children': [], 'path': '[Gmail]/Trash', 'displayName': 'Trash' }], 'path': '[Gmail]', 'displayName': '[Gmail]' }] }

    // await client.close()
    res.json(mailboxes.children)
  },
  listMessages: async (req, res) => {
    const { clientBuilder, providerOpts } = await boxes.helpers.imap()
    const { unhash } = await boxes.helpers.hashids()
    const passport = await Passport.findOne({ id: unhash(req.params.provider) })

    const boxPath = Buffer.from(req.params.box, 'base64').toString('utf8')
    const offset = req.query.offset

    const perPage = 50

    // const client = await clientBuilder({
    //   ...providerOpts[passport.provider],
    //   auth: {
    //     user: passport.email,
    //     xoauth2: passport.accessToken
    //   }
    // })

    // const messages = await client.listMessages(
    //   boxPath,
    //   offset && offset > perPage ? `${offset - perPage + 1}:${offset}` : `0:${perPage - 1}`,
    //   ['uid', 'flags', 'envelope']
    // )
    // await client.close()
    const messages = [{ '#': 614, 'uid': 21798, 'flags': ['\\Seen'], 'envelope': { 'date': 'Mon, 24 Jun 2019 11:13:42 +0800', 'subject': 'MindMeet Product Call', 'from': [{ 'address': 'connect@mindmeet.us', 'name': 'The MindMeet Team' }], 'sender': [{ 'address': 'connect@mindmeet.us', 'name': 'The MindMeet Team' }], 'reply-to': [{ 'address': 'connect@mindmeet.us', 'name': 'The MindMeet Team' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': 'Theodore Kluge' }], 'message-id': '<CADHnOz9F3Vp1XA7rzUJ=DpQc6-TS0VGdnFKs6Apsjbb7cANTzw@mail.gmail.com>' } }, { '#': 613, 'uid': 21795, 'flags': ['\\Seen'], 'envelope': { 'date': 'Sun, 23 Jun 2019 15:45:02 +0000 (UTC)', 'subject': 'Appointment Reminder: Follow-Up is on Wednesday, June 26, 2019 11:30am (Michael Jackson MD)', 'from': [{ 'address': 'scheduling@acuityscheduling.com', 'name': 'Michael B. Jackson MD, LLC' }], 'sender': [{ 'address': 'scheduling@acuityscheduling.com', 'name': 'Michael B. Jackson MD, LLC' }], 'reply-to': [{ 'address': 'mbjacksonmd@hotmail.com', 'name': 'Michael B. Jackson MD, LLC' }], 'to': [{ 'address': 'villa7.kluge5@gmail.com', 'name': '' }], 'message-id': '<a5c406c4a43c0d3a7426a2cf7b536a52@churchill-backend-production-queue-worker-task>' } }, { '#': 612, 'uid': 21786, 'flags': ['\\Seen'], 'envelope': { 'date': '22 Jun 2019 13:08:57 -0700', 'subject': 'Thank you for Applying for the Software Developer Position on CyberCoders', 'from': [{ 'address': 'no-reply@cybercoders.com', 'name': 'CyberCoders' }], 'sender': [{ 'address': 'no-reply@cybercoders.com', 'name': 'CyberCoders' }], 'reply-to': [{ 'address': 'no-reply@cybercoders.com', 'name': 'CyberCoders' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': '' }], 'message-id': '<SMTP27ChuoVYla7hcQe000bdf0f@smtp2.cybercoders.net>' } }, { '#': 611, 'uid': 21784, 'flags': ['\\Seen'], 'envelope': { 'date': 'Sat, 22 Jun 2019 19:39:17 +0000', 'subject': 'Your application for Software Engineer (Front End) at WW', 'from': [{ 'address': 'notification@jobvite.com', 'name': 'WW International (formerly Weight Watchers) Recruiting Team' }], 'sender': [{ 'address': 'notification@jobvite.com', 'name': 'WW International (formerly Weight Watchers) Recruiting Team' }], 'reply-to': [{ 'address': 'jjy2r49sb@jobvite.com', 'name': 'WW International (formerly Weight Watchers) Recruiting Team' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': 'Theodore Kluge' }], 'message-id': '<0100016b80b3391a-adeffa8a-3cab-4d91-b88d-e7f376350b97-000000@email.amazonses.com>' } }, { '#': 610, 'uid': 21783, 'flags': ['\\Seen'], 'envelope': { 'date': 'Sat, 22 Jun 2019 19:30:12 +0000', 'subject': 'Your Application Has Been Successfully Submitted', 'from': [{ 'address': 'amex@inmail.application.jobs', 'name': 'American Express Careers' }], 'sender': [{ 'address': 'amex@inmail.application.jobs', 'name': '' }], 'reply-to': [{ 'address': 'noreply@inmail.application.jobs', 'name': 'The Jibe Team' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': '' }], 'message-id': '<20190622193012.1.2D9CBCB5870E9082@inmail.application.jobs>' } }, { '#': 609, 'uid': 21782, 'flags': ['\\Seen'], 'envelope': { 'date': 'Sat, 22 Jun 2019 15:30:10 -0400 (EDT)', 'subject': 'Engineer - Full Stack Web-19009931 at American Express', 'from': [{ 'address': 'hr-axp@invalidemail.com', 'name': 'AXP Human Resources' }], 'sender': [{ 'address': 'hr-axp@invalidemail.com', 'name': 'AXP Human Resources' }], 'reply-to': [{ 'address': 'hr-axp@invalidemail.com', 'name': 'AXP Human Resources' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': 'Theodore Kluge' }], 'message-id': '<458296913.306707.1561231810620@127.0.0.1>' } }, { '#': 608, 'uid': 21781, 'flags': ['\\Seen'], 'envelope': { 'date': 'Sat, 22 Jun 2019 19:17:03 +0000', 'subject': 'Thank you for applying to Clover!', 'from': [{ 'address': 'no-reply@greenhouse.io', 'name': '' }], 'sender': [{ 'address': 'no-reply@greenhouse.io', 'name': '' }], 'reply-to': [{ 'address': 'no-reply@greenhouse.io', 'name': '' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': '' }], 'message-id': '<20190622191703.1.399B46427BFCFECC@greenhouse.io>' } }, { '#': 607, 'uid': 21760, 'flags': ['\\Seen'], 'envelope': { 'date': 'Fri, 21 Jun 2019 07:21:48 +0000', 'subject': '[MindMeet] Production ActiveRecord::RecordNotFound: Not Found', 'from': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': 'Airbrake' }], 'sender': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': '' }], 'reply-to': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': 'Airbrake' }], 'to': [{ 'address': 'cuecheruo@gmail.com', 'name': '' }, { 'address': 'eugene@enspiral.com', 'name': '' }, { 'address': 'gigameet@cornucopic.com', 'name': '' }, { 'address': 'james@triumphtech.io', 'name': '' }, { 'address': 'theo@mindmeet.us', 'name': '' }], 'message-id': '<5d0c858c75107_75633ff4643db1284853b@production-ab-worker-notifications-3.mail>' } }, { '#': 606, 'uid': 21748, 'flags': ['\\Seen'], 'envelope': { 'date': 'Thu, 20 Jun 2019 18:52:29 +0000 (UTC)', 'subject': 'My contact information and a position for your review', 'from': [{ 'address': 'inmail-hit-reply@linkedin.com', 'name': 'Charly Viemeister' }], 'sender': [{ 'address': 'inmail-hit-reply@linkedin.com', 'name': 'Charly Viemeister' }], 'reply-to': [{ 'address': '9d4dfe95-3767-4e8e-b06c-c4ec562ebbb8@reply.linkedin.com', 'name': 'Charly Viemeister' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': 'Theodore Kluge' }], 'message-id': '<715334019.1180539.1561056749602.JavaMail.app@lva1-app3944.prod.linkedin.com>' } }, { '#': 605, 'uid': 21739, 'flags': ['\\Seen'], 'envelope': { 'date': 'Thu, 20 Jun 2019 13:33:02 +0000 (UTC)', 'subject': 'Hi Theodore, please add me to your professional network', 'from': [{ 'address': 'invitations@linkedin.com', 'name': 'Bri Maloney' }], 'sender': [{ 'address': 'invitations@linkedin.com', 'name': 'Bri Maloney' }], 'reply-to': [{ 'address': 'invitations@linkedin.com', 'name': 'Bri Maloney' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': 'Theodore Kluge' }], 'message-id': '<1994821520.1607335.1561037582021.JavaMail.app@ltx1-app6386.prod.linkedin.com>' } }, { '#': 604, 'uid': 21737, 'flags': ['\\Seen'], 'envelope': { 'date': 'Thu, 20 Jun 2019 08:08:26 -0500', 'subject': 'View Count', 'from': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'sender': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'reply-to': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': 'Theodore Kluge' }], 'message-id': '<CANzt=MdTgJdkjREv-jNiSHRqdKFCEkAvfakQi0ydV5idgx2Gmg@mail.gmail.com>' } }, { '#': 603, 'uid': 21733, 'flags': ['\\Seen'], 'envelope': { 'date': 'Thu, 20 Jun 2019 12:55:47 +0000', 'subject': 'Chinedu Echeruo added you to the card I dont think the Likes work. It still shows 1 view and I know Pamela and I have vieweed the page more than 1 time on Sprint Playdeck at 8:53 AM on June 20, 2019', 'from': [{ 'address': 'do-not-reply@trello.com', 'name': 'Trello' }], 'sender': [{ 'address': 'Trello@', 'name': '<do-not-reply@trello.com>' }], 'reply-to': [{ 'address': 'tkluge+2qe3uaml8bo0ei52fgb+2si75edbkmjualiccuw+28yfolg5w7@boards.trello.com', 'name': '' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': '' }], 'message-id': '<15610353474912cd35608@trello.com>' } }, { '#': 602, 'uid': 21720, 'flags': ['\\Seen'], 'envelope': { 'date': 'Wed, 19 Jun 2019 18:55:06 +0000', 'subject': 'Thanks for your interest in Galileo!', 'from': [{ 'address': 'no-reply@galileo.io', 'name': '' }], 'sender': [{ 'address': 'no-reply@galileo.io', 'name': '' }], 'reply-to': [{ 'address': 'no-reply@galileo.io', 'name': '' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': '' }], 'message-id': '<20190619185506.1.70DED2D9E35DA0C0@gh-mail.galileo.io>' } }, { '#': 601, 'uid': 21718, 'flags': ['\\Seen'], 'envelope': { 'date': 'Wed, 19 Jun 2019 18:28:03 +0000', 'subject': 'Thank you for your application to Paperspace', 'from': [{ 'address': 'no-reply@hire.lever.co', 'name': 'Paperspace' }], 'sender': [{ 'address': 'no-reply@hire.lever.co', 'name': '' }], 'reply-to': [{ 'address': 'no-reply@hire.lever.co', 'name': 'Paperspace' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': '' }], 'message-id': '<20190619182803.1.70CB493B76057492@hire.lever.co>' } }, { '#': 600, 'uid': 21710, 'flags': ['\\Seen'], 'envelope': { 'date': 'Wed, 19 Jun 2019 16:32:52 +0000', 'subject': 'Do Something Epic', 'from': [{ 'address': 'Maritess@epic.com', 'name': 'Maritess Escueta' }], 'sender': [{ 'address': 'Maritess@epic.com', 'name': 'Maritess Escueta' }], 'reply-to': [{ 'address': 'Maritess@epic.com', 'name': '' }], 'to': [{ 'address': 'tkluge@stevens.edu', 'name': 'Theodore K Kluge' }], 'message-id': '<2b7bb155dfd44a7cb0b5e7ef83bf455f@BN8PR10MB3219.namprd10.prod.outlook.com>' } }, { '#': 599, 'uid': 21620, 'flags': ['\\Answered', '\\Seen'], 'envelope': { 'date': 'Sat, 08 Jun 2019 18:52:55 +0000 (UTC)', 'subject': 'Theodore a couple more questions...', 'from': [{ 'address': 'regan@ironpaper.com', 'name': 'Regan Venezia' }], 'sender': [{ 'address': 'regan@ironpaper.com', 'name': 'Regan Venezia' }], 'reply-to': [{ 'address': 'regan@ironpaper.com', 'name': '' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': '' }], 'message-id': '<1560019972512.580f6096-fac9-4f98-8134-b11a0c7394a7@mail8.shared.hubspot.com>' } }, { '#': 598, 'uid': 21568, 'flags': ['\\Seen'], 'envelope': { 'date': 'Mon, 10 Jun 2019 21:19:50 -0400', 'subject': 'Re: Mindmeet twitter auth', 'from': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'sender': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'reply-to': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': 'Theodore Kluge' }], 'cc': [{ 'address': 'builder@mindmeet.us', 'name': 'Pamela Abalu' }, { 'address': 'connect@mindmeet.us', 'name': 'MindMeet Scheduling' }, { 'address': 'engage@loveandmagic.company', 'name': 'Nicole Serrano' }], 'in-reply-to': '<CALnM_ZHmmfKu+nk380W-C4xNhMPPFORtmCuSCVHdbSp1=nYjgw@mail.gmail.com>', 'message-id': '<CANzt=McR4CXx6q-Y+EodU6Y8Tjf2qLEiBENZ4bQ369UUiFMk8A@mail.gmail.com>' } }, { '#': 597, 'uid': 21539, 'flags': ['\\Seen'], 'envelope': { 'date': 'Sun, 9 Jun 2019 00:46:18 -0400', 'subject': 'Re: Action Required - Your certificate renewal', 'from': [{ 'address': 'dreamer@mindmeet.us', 'name': 'Chinedu Echeruo' }], 'sender': [{ 'address': 'dreamer@mindmeet.us', 'name': 'Chinedu Echeruo' }], 'reply-to': [{ 'address': 'dreamer@mindmeet.us', 'name': 'Chinedu Echeruo' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': 'Theodore Kluge' }], 'in-reply-to': '<CALnM_ZGq7Uur3kjYrwwZB3Hoo8KNfZ9k+ASqAgPA0n2WysC+5g@mail.gmail.com>', 'message-id': '<CAMwp0WE-quvmBrMkotT495RbpMLbkUDW4ydY+AB1vXxeUXctEA@mail.gmail.com>' } }, { '#': 596, 'uid': 21531, 'flags': ['\\Seen'], 'envelope': { 'date': 'Sat, 8 Jun 2019 10:48:47 -0400', 'subject': 'Fwd: Action Required - Your certificate renewal', 'from': [{ 'address': 'dreamer@mindmeet.us', 'name': 'Chinedu Echeruo' }], 'sender': [{ 'address': 'dreamer@mindmeet.us', 'name': 'Chinedu Echeruo' }], 'reply-to': [{ 'address': 'dreamer@mindmeet.us', 'name': 'Chinedu Echeruo' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': 'Theodore Kluge' }], 'in-reply-to': '<0100016b371719b7-0b97398e-7bf5-4051-86e9-c0d1b2bf050e-000000@email.amazonses.com>', 'message-id': '<CAMwp0WEwnO4cNepXPsso6_pooT=nKCGYrTvWo5VuPd29kUfzqA@mail.gmail.com>' } }, { '#': 595, 'uid': 21507, 'flags': ['\\Seen'], 'envelope': { 'date': 'Thu, 6 Jun 2019 18:35:53 +0000', 'subject': '​Frontend Engineer​ at Vigilant', 'from': [{ 'address': 'candidate-e8ee009cd5f3@vigilant.breezy-mail.com', 'name': 'Chris Novak' }], 'sender': [{ 'address': 'candidate-e8ee009cd5f3@vigilant.breezy-mail.com', 'name': 'Chris Novak' }], 'reply-to': [{ 'address': 'candidate-e8ee009cd5f3@vigilant.breezy-mail.com', 'name': 'Chris Novak' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': '' }], 'message-id': '<0100016b2e136beb-7e437793-2ae3-46a2-aac1-0edcdedcbb41-000000@email.amazonses.com>' } }, { '#': 594, 'uid': 21487, 'flags': ['\\Seen'], 'envelope': { 'date': 'Thu, 6 Jun 2019 01:17:04 +0800', 'subject': 'Fwd: Twitter developer account application [ ref:_00DA0K0A8._5004A1hMYBh:ref ]', 'from': [{ 'address': 'hello@mindmeet.us', 'name': 'Ayme Sinclair' }], 'sender': [{ 'address': 'hello@mindmeet.us', 'name': 'Ayme Sinclair' }], 'reply-to': [{ 'address': 'hello@mindmeet.us', 'name': 'Ayme Sinclair' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': 'Theodore Kluge' }], 'in-reply-to': '<72.97.13825.E5582FC5@mail.twitter.com>', 'message-id': '<CACoAwBBrrQzUmEo-01zutMPhN0tj8d8U=mF6yAi87MqodNOU8w@mail.gmail.com>' } }, { '#': 593, 'uid': 21468, 'flags': ['\\Seen'], 'envelope': { 'date': 'Tue, 4 Jun 2019 17:40:52 -0400', 'subject': 'Fwd: You have pending meeting requests', 'from': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'sender': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'reply-to': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': 'Theodore Kluge' }], 'in-reply-to': '<CAA8EcAQbfuyRo_aWZ_PY=Ux=4NxShnpxsx3EXYX3dAW8eFZotg@mail.gmail.com>', 'message-id': '<CANzt=Mdgiab9Z7ZsotCm4aLjomMNhuvucr1rcSkYK=vba2rKHA@mail.gmail.com>' } }, { '#': 592, 'uid': 21462, 'flags': ['\\Seen'], 'envelope': { 'date': 'Tue, 4 Jun 2019 19:03:14 +0000', 'subject': 'You have pending meeting requests', 'from': [{ 'address': 'no-reply@mindmeet.us', 'name': 'MindMeet' }], 'sender': [{ 'address': 'no-reply@mindmeet.us', 'name': 'MindMeet' }], 'reply-to': [{ 'address': 'no-reply@mindmeet.us', 'name': 'MindMeet' }], 'to': [{ 'address': 'villa7.kluge5@gmail.com', 'name': '' }], 'message-id': '<0100016b23dfbd97-b89122e0-c0a2-49e4-bee0-4ec3c5b78794-000000@email.amazonses.com>' } }, { '#': 591, 'uid': 21461, 'flags': ['\\Seen'], 'envelope': { 'date': 'Tue, 4 Jun 2019 18:59:41 +0000', 'subject': 'You have pending meeting requests', 'from': [{ 'address': 'no-reply@mindmeet.us', 'name': 'MindMeet' }], 'sender': [{ 'address': 'no-reply@mindmeet.us', 'name': 'MindMeet' }], 'reply-to': [{ 'address': 'no-reply@mindmeet.us', 'name': 'MindMeet' }], 'to': [{ 'address': 'me@tkluge.net', 'name': '' }], 'message-id': '<0100016b23dc7f73-1d1c6ffc-ebe8-4179-bec7-024f9f6b2b78-000000@email.amazonses.com>' } }, { '#': 590, 'uid': 21441, 'flags': ['\\Seen'], 'envelope': { 'date': 'Tue, 4 Jun 2019 06:19:30 +0800', 'subject': 'Invoice', 'from': [{ 'address': 'engage@loveandmagic.company', 'name': 'Nicole Serrano' }], 'sender': [{ 'address': 'engage@loveandmagic.company', 'name': 'Nicole Serrano' }], 'reply-to': [{ 'address': 'engage@loveandmagic.company', 'name': 'Nicole Serrano' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': 'Theodore Kluge' }], 'message-id': '<CAC_QMUm103tKH_RwA0HMo+F-Veh-cYpYpmdcJJyot9kqdwXYUA@mail.gmail.com>' } }, { '#': 589, 'uid': 21407, 'flags': ['\\Answered', '\\Seen'], 'envelope': { 'date': 'Sat, 01 Jun 2019 14:08:07 -0400', 'subject': 'Your Graduation Proofs are Online', 'from': [{ 'address': 'custserv@islandphoto.com', 'name': 'Island Photography' }], 'sender': [{ 'address': 'custserv@islandphoto.com', 'name': 'Island Photography' }], 'reply-to': [{ 'address': 'custserv@islandphoto.com', 'name': '' }], 'to': [{ 'address': 'TKLUGE@tkluge.net', 'name': '' }], 'message-id': '<50fe3376d7ba4fa0b7bf61304dcdf2de@islandphoto.com>' } }, { '#': 588, 'uid': 21392, 'flags': ['\\Seen'], 'envelope': { 'date': '31 May 2019 21:07:07 -0500', 'subject': 'eTicket Itinerary and Receipt for Confirmation F3FLSW', 'from': [{ 'address': 'unitedairlines@united.com', 'name': 'United Airlines, Inc.' }], 'sender': [{ 'address': 'unitedairlines@united.com', 'name': 'United Airlines, Inc.' }], 'reply-to': [{ 'address': 'unitedairlines@united.com', 'name': 'United Airlines, Inc.' }], 'to': [{ 'address': 'VILLA7.KLUGE5@gmail.com', 'name': '' }], 'message-id': '<D3.37.26608.BCDD1FC5@mx2.coair.com>' } }, { '#': 587, 'uid': 21391, 'flags': ['\\Seen'], 'envelope': { 'date': '31 May 2019 22:05:10 -0400', 'subject': 'Your United reservation for Pittsburgh, PA, US (PIT) is processing', 'from': [{ 'address': 'unitedairlines@united.com', 'name': 'United Airlines, Inc.' }], 'sender': [{ 'address': 'unitedairlines@united.com', 'name': 'United Airlines, Inc.' }], 'reply-to': [{ 'address': 'unitedairlines@united.com', 'name': 'United Airlines, Inc.' }], 'to': [{ 'address': 'villa7.kluge5@gmail.com', 'name': '' }], 'message-id': '<2D.F5.09207.75DD1FC5@mx2.coair.com>' } }, { '#': 586, 'uid': 21351, 'flags': ['\\Seen'], 'envelope': { 'date': 'Thu, 30 May 2019 13:37:22 -0700', 'subject': 'New Coverage  issue detected for site https://www.mindmeet.us/', 'from': [{ 'address': 'sc-noreply@google.com', 'name': 'Google Search Console Team' }], 'sender': [{ 'address': 'sc-noreply@google.com', 'name': 'Google Search Console Team' }], 'reply-to': [{ 'address': 'sc-noreply@google.com', 'name': 'Google Search Console Team' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': '' }], 'message-id': '<9afe2dcc29be944d36c69920d46494253fe8f747-10030322-100159012@google.com>' } }, { '#': 585, 'uid': 21326, 'flags': ['\\Seen'], 'envelope': { 'date': 'Wed, 29 May 2019 16:45:36 -0500', 'subject': 'Fwd: [MindMeet/mindmeet-rails] One of your dependencies has a security vulnerability', 'from': [{ 'address': 'chinedu@loveandmagic.company', 'name': 'Chinedu Echeruo' }], 'sender': [{ 'address': 'chinedu@loveandmagic.company', 'name': 'Chinedu Echeruo' }], 'reply-to': [{ 'address': 'chinedu@loveandmagic.company', 'name': 'Chinedu Echeruo' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': '' }], 'in-reply-to': '<MindMeet/mindmeet-rails/vulnerability-alerts/MDI4OlJlcG9zaXRvcnlWdWxuZXJhYmlsaXR5QWxlcnQ5MzU3NzEzOQ==@github.com>', 'message-id': '<CAJ1=6ELKcjyh0uC=JXNdOeRc-uHMgbtOu=1UHPspenJokTt1=Q@mail.gmail.com>' } }, { '#': 584, 'uid': 21297, 'flags': ['\\Answered', '\\Seen'], 'envelope': { 'date': 'Tue, 28 May 2019 17:29:47 +0000', 'subject': '[All_ugrads_graduating] Commencement 2019: Photos and Videos', 'from': [{ 'address': 'donotreply@stevens.edu', 'name': 'donotreply' }], 'sender': [{ 'address': '"all_ugrads_graduating-bounces@lists.stevens.edu"@', 'name': '<all_ugrads_graduating-bounces@lists.stevens.edu>' }], 'reply-to': [{ 'address': 'donotreply@stevens.edu', 'name': 'donotreply' }], 'to': [{ 'address': 'all_ugrads_graduating@lists.stevens.edu', 'name': '' }, { 'address': 'all_grads_graduating@lists.stevens.edu', 'name': '' }], 'message-id': '<ce47b45d2ad84c4c8d943f3b30ac1f88@BN8PR10MB3219.namprd10.prod.outlook.com>' } }, { '#': 583, 'uid': 21232, 'flags': ['\\Seen'], 'envelope': { 'date': 'Fri, 24 May 2019 12:28:25 +0000', 'subject': '[MindMeet] Staging OAuth::Unauthorized: 403 Forbidden', 'from': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': 'Airbrake' }], 'sender': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': '' }], 'reply-to': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': 'Airbrake' }], 'to': [{ 'address': 'cuecheruo@gmail.com', 'name': '' }, { 'address': 'eugene@enspiral.com', 'name': '' }, { 'address': 'gigameet@cornucopic.com', 'name': '' }, { 'address': 'james@triumphtech.io', 'name': '' }, { 'address': 'theo@mindmeet.us', 'name': '' }], 'message-id': '<5ce7e3699cf4_8233fd71fcdb140854bd@production-ab-worker-notifications-1.mail>' } }, { '#': 582, 'uid': 21231, 'flags': ['\\Seen'], 'envelope': { 'date': 'Thu, 23 May 2019 22:30:47 -0400', 'subject': 'Re: ba', 'from': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'sender': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'reply-to': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': 'Theodore Kluge' }], 'in-reply-to': '<CA+4-w=WWTXiz8udvFQT9Q22DAj1+mUCFobCL4CMqEjC6wnLwLg@mail.gmail.com>', 'message-id': '<a06bc638-b39f-237b-04d3-4d4b9d9a96cf@verizon.net>' } }, { '#': 581, 'uid': 21214, 'flags': ['\\Seen'], 'envelope': { 'date': 'Thu, 23 May 2019 05:28:39 +0000', 'subject': '[MindMeet] Staging OAuth::Unauthorized: 403 Forbidden', 'from': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': 'Airbrake' }], 'sender': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': '' }], 'reply-to': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': 'Airbrake' }], 'to': [{ 'address': 'cuecheruo@gmail.com', 'name': '' }, { 'address': 'eugene@enspiral.com', 'name': '' }, { 'address': 'gigameet@cornucopic.com', 'name': '' }, { 'address': 'james@triumphtech.io', 'name': '' }, { 'address': 'theo@mindmeet.us', 'name': '' }], 'message-id': '<5ce62f87901f9_3b9f3ff0837db140434aa@production-ab-worker-notifications-1.mail>' } }, { '#': 580, 'uid': 21211, 'flags': ['\\Flagged', '\\Seen'], 'envelope': { 'date': 'Wed, 22 May 2019 20:34:34 +0000', 'subject': 'Registration Confirmation To Anthrocon 2019', 'from': [{ 'address': 'noreply@regfox.com', 'name': 'Anthrocon Registration' }], 'sender': [{ 'address': 'noreply@regfox.com', 'name': 'Anthrocon Registration' }], 'reply-to': [{ 'address': 'registration@anthrocon.org', 'name': '' }], 'to': [{ 'address': 'tkluge@tkluge.net', 'name': 'Theodore Kluge' }], 'message-id': '<0101016ae140b2bd-f05c20be-62e3-4e70-90e8-a79501fa30b3-000000@us-west-2.amazonses.com>' } }, { '#': 579, 'uid': 21210, 'flags': ['\\Seen'], 'envelope': { 'date': 'Wed, 22 May 2019 16:06:48 -0400', 'subject': 'Stevens Commencement - banner', 'from': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'sender': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'reply-to': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'to': [{ 'address': 'klugee@st.northernhighlands.org', 'name': '' }, { 'address': 'villa7.kluge5@gmail.com', 'name': 'Theodore Kluge' }, { 'address': 'kluge5@verizon.net', 'name': '' }], 'message-id': '<fe07dd62-43ab-da21-fb77-57cf4f461706@verizon.net>' } }, { '#': 578, 'uid': 21209, 'flags': ['\\Seen'], 'envelope': { 'date': 'Wed, 22 May 2019 16:05:58 -0400', 'subject': 'Fwd: Stevens Commencement - in seats', 'from': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'sender': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'reply-to': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'to': [{ 'address': 'klugee@st.northernhighlands.org', 'name': '' }, { 'address': 'villa7.kluge5@gmail.com', 'name': 'Theodore Kluge' }, { 'address': 'kluge5@verizon.net', 'name': '' }], 'in-reply-to': '<220bebc9-3ba0-da03-c25a-1b4a6f723211@verizon.net>', 'message-id': '<c3684f36-00a5-1e70-344f-bfd2f0af743e@verizon.net>' } }, { '#': 577, 'uid': 21208, 'flags': ['\\Seen'], 'envelope': { 'date': 'Wed, 22 May 2019 16:05:12 -0400', 'subject': 'Fwd: Stevens Commencement photo - on dais', 'from': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'sender': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'reply-to': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'to': [{ 'address': 'klugee@st.northernhighlands.org', 'name': '' }, { 'address': 'villa7.kluge5@gmail.com', 'name': 'Theodore Kluge' }, { 'address': 'kluge5@verizon.net', 'name': '' }], 'in-reply-to': '<73c4d8e7-6eaa-b50f-2f83-431b016f190d@verizon.net>', 'message-id': '<0cdd4e30-47d5-5429-fe47-a5f635b88caa@verizon.net>' } }, { '#': 576, 'uid': 21194, 'flags': ['\\Seen'], 'envelope': { 'date': 'Tue, 21 May 2019 21:51:13 +0000', 'subject': '[All_ugrads_graduating] Congratulations to the new Class of 2019 Officers!', 'from': [{ 'address': 'donotreply@stevens.edu', 'name': 'donotreply' }], 'sender': [{ 'address': '"all_ugrads_graduating-bounces@lists.stevens.edu"@', 'name': '<all_ugrads_graduating-bounces@lists.stevens.edu>' }], 'reply-to': [{ 'address': 'donotreply@stevens.edu', 'name': 'donotreply' }], 'to': [{ 'address': 'all_ugrads_graduating@lists.stevens.edu', 'name': '' }], 'message-id': '<2f4aa5c77d8849428df6a1e82bba1b40@BN8PR10MB3219.namprd10.prod.outlook.com>' } }, { '#': 575, 'uid': 21182, 'flags': ['\\Seen'], 'envelope': { 'date': 'Tue, 21 May 2019 14:46:47 +0000', 'subject': 'Re-check your final grades please!: 2019S CS  -554-WS', 'from': [{ 'address': 'notifications@instructure.com', 'name': '2019S CS -554-WS' }], 'sender': [{ 'address': 'notifications@instructure.com', 'name': '2019S CS -554-WS' }], 'reply-to': [{ 'address': 'reply+36403b9b70470e2d20f953c9f4664d02e166ac7d-1030~20884471-1558450004@notifications.canvaslms.com', 'name': '' }], 'to': [{ 'address': 'tkluge@stevens.edu', 'name': 'Theodore K Kluge' }], 'message-id': '<7a9722cdc99b46818d97195daea37c3b@BN8PR10MB3219.namprd10.prod.outlook.com>' } }, { '#': 574, 'uid': 21176, 'flags': ['\\Seen'], 'envelope': { 'date': 'Tue, 21 May 2019 12:07:41 +0000', 'subject': '[Stevens Announcement] Commencement Day 2019', 'from': [{ 'address': 'donotreply@stevens.edu', 'name': 'donotreply' }], 'sender': [{ 'address': '"all_students_faculty_staff-bounces@lists.stevens.edu"@', 'name': '<all_students_faculty_staff-bounces@lists.stevens.edu>' }], 'reply-to': [{ 'address': 'donotreply@stevens.edu', 'name': 'donotreply' }], 'to': [{ 'address': 'all_students_faculty_staff@lists.stevens.edu', 'name': '' }], 'message-id': '<af6b1e92ec144db19b1ccb621fa2512d@BN8PR10MB3219.namprd10.prod.outlook.com>' } }, { '#': 573, 'uid': 21173, 'flags': ['\\Seen'], 'envelope': { 'date': 'Tue, 21 May 2019 09:07:50 +0000', 'subject': 'Theodore, explore jobs at Itlize Global LLC, SPHERE Technology Solutions and more', 'from': [{ 'address': 'handshake@notifications.joinhandshake.com', 'name': 'Handshake' }], 'sender': [{ 'address': 'handshake@notifications.joinhandshake.com', 'name': 'Handshake' }], 'reply-to': [{ 'address': 'handshake@notifications.joinhandshake.com', 'name': 'Handshake' }], 'to': [{ 'address': 'tkluge@stevens.edu', 'name': 'Theodore K Kluge' }], 'message-id': '<7a563e7f104c4d4babca8990f1190f33@BN8PR10MB3219.namprd10.prod.outlook.com>' } }, { '#': 572, 'uid': 21172, 'flags': ['\\Seen'], 'envelope': { 'date': 'Mon, 20 May 2019 22:05:29 -0400', 'subject': 'Contact info for your aunts and uncles', 'from': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'sender': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'reply-to': [{ 'address': 'kluge5@verizon.net', 'name': 'Michika Saito' }], 'to': [{ 'address': 'klugee@st.northernhighlands.org', 'name': '' }, { 'address': 'tkluge@tkluge.net', 'name': 'Theodore Kluge' }], 'message-id': '<54261ad8-ba3d-e4a7-a80c-fcab00c8b050@verizon.net>' } }, { '#': 571, 'uid': 21162, 'flags': ['\\Seen'], 'envelope': { 'date': 'Mon, 20 May 2019 14:30:34 -0400', 'subject': 'Re: Monday meeting', 'from': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'sender': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'reply-to': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': 'Theodore Kluge' }], 'in-reply-to': '<CANzt=MeNPpYphiek9GOcB2nvDzS6GY3SQtk7YAC-BnRgGoQjAA@mail.gmail.com>', 'message-id': '<CANzt=MerWwKPRyfmqAsNWuLfW2AaJr2V2xdnW4wZuuVhigtr0Q@mail.gmail.com>' } }, { '#': 570, 'uid': 21161, 'flags': ['\\Seen'], 'envelope': { 'date': 'Mon, 20 May 2019 14:24:17 -0400', 'subject': 'Re: Monday meeting', 'from': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'sender': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'reply-to': [{ 'address': 'cuecheruo@gmail.com', 'name': 'Chinedu Echeruo' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': 'Theodore Kluge' }], 'in-reply-to': '<CALnM_ZGhw_wiUtUCCNhfP+DGXe12xzOdipTWi6X+GYqJMdwoOQ@mail.gmail.com>', 'message-id': '<CANzt=MeNPpYphiek9GOcB2nvDzS6GY3SQtk7YAC-BnRgGoQjAA@mail.gmail.com>' } }, { '#': 569, 'uid': 21151, 'flags': ['\\Seen'], 'envelope': { 'date': 'Mon, 20 May 2019 11:26:02 +0000', 'subject': '[All_ugrads_graduating] Commencement 2019: Reminders', 'from': [{ 'address': 'donotreply@stevens.edu', 'name': 'donotreply' }], 'sender': [{ 'address': '"all_ugrads_graduating-bounces@lists.stevens.edu"@', 'name': '<all_ugrads_graduating-bounces@lists.stevens.edu>' }], 'reply-to': [{ 'address': 'donotreply@stevens.edu', 'name': 'donotreply' }], 'to': [{ 'address': 'all_ugrads_graduating@lists.stevens.edu', 'name': '' }, { 'address': 'all_grads_graduating@lists.stevens.edu', 'name': '' }], 'message-id': '<9d64b4fa50b140d995e5cceff32bc74a@BN8PR10MB3219.namprd10.prod.outlook.com>' } }, { '#': 568, 'uid': 21103, 'flags': ['\\Seen'], 'envelope': { 'date': 'Thu, 16 May 2019 19:55:48 +0000', 'subject': ' Přemysl Donát mentioned you on the card Make tests and CI work again on Sprint Playdeck at 3:54 PM on May 16, 2019', 'from': [{ 'address': 'do-not-reply@trello.com', 'name': 'Trello' }], 'sender': [{ 'address': 'Trello@', 'name': '<do-not-reply@trello.com>' }], 'reply-to': [{ 'address': 'tkluge+2qe3uaml8bo0ei52fgb+2saqwogrwhfqrfqebxr+1kz5zx27t3@boards.trello.com', 'name': '' }], 'to': [{ 'address': 'theo@mindmeet.us', 'name': '' }], 'message-id': '<1558036548366caf4ce5b@trello.com>' } }, { '#': 567, 'uid': 21085, 'flags': ['\\Seen'], 'envelope': { 'date': 'Thu, 16 May 2019 00:16:26 +0000', 'subject': '[MindMeet] Production Hashids::InputError: unable to unhash', 'from': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': 'Airbrake' }], 'sender': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': '' }], 'reply-to': [{ 'address': 'donotreply@alerts.airbrake.io', 'name': 'Airbrake' }], 'to': [{ 'address': 'cuecheruo@gmail.com', 'name': '' }, { 'address': 'eugene@enspiral.com', 'name': '' }, { 'address': 'gigameet@cornucopic.com', 'name': '' }, { 'address': 'james@triumphtech.io', 'name': '' }, { 'address': 'theo@mindmeet.us', 'name': '' }], 'message-id': '<5cdcabda3b848_60e33fa593ddb10c6875@production-ab-worker-notifications-4.mail>' } }, { '#': 566, 'uid': 21076, 'flags': ['\\Seen'], 'envelope': { 'date': 'Wed, 15 May 2019 15:48:47 +0000', 'subject': 'Closing Reminder', 'from': [{ 'address': 'cmcguire@stevens.edu', 'name': 'Catherine M McGuire' }], 'sender': [{ 'address': 'cmcguire@stevens.edu', 'name': 'Catherine M McGuire' }], 'reply-to': [{ 'address': 'cmcguire@stevens.edu', 'name': 'Catherine M McGuire' }], 'in-reply-to': '<BN6PR10MB14572233175ACA733E795A6BCD090@BN6PR10MB1457.namprd10.prod.outlook.com>', 'message-id': '<a5897dae9dc44af682297e91f4cb2d26@BN8PR10MB3219.namprd10.prod.outlook.com>' } }, { '#': 565, 'uid': 21067, 'flags': ['\\Seen'], 'envelope': { 'date': 'Wed, 15 May 2019 12:01:17 +0000', 'subject': '[All_ugrads_graduating] Commencement 2019: Arrival Times and Transportation', 'from': [{ 'address': 'donotreply@stevens.edu', 'name': 'donotreply' }], 'sender': [{ 'address': '"all_ugrads_graduating-bounces@lists.stevens.edu"@', 'name': '<all_ugrads_graduating-bounces@lists.stevens.edu>' }], 'reply-to': [{ 'address': 'donotreply@stevens.edu', 'name': 'donotreply' }], 'to': [{ 'address': 'all_ugrads_graduating@lists.stevens.edu', 'name': '' }, { 'address': 'all_grads_graduating@lists.stevens.edu', 'name': '' }], 'message-id': '<766deee9982e4f209116ba53834cecfc@BN8PR10MB3219.namprd10.prod.outlook.com>' } }].reverse()
    res.json(messages.reverse())
  },
  fetchMessages: async (req, res) => {
    const uids = req.params.uids
    const { clientBuilder, providerOpts, parseMime } = await boxes.helpers.imap()
    const { unhash } = await boxes.helpers.hashids()
    const passport = await Passport.findOne({ id: unhash(req.params.provider) })

    const boxPath = Buffer.from(req.params.box, 'base64').toString('utf8')
    let messages
    // const client = await clientBuilder({
    //   ...providerOpts[passport.provider],
    //   auth: {
    //     user: passport.email,
    //     xoauth2: passport.accessToken
    //   }
    // })

    // messages = await client.listMessages(boxPath, uids, ['uid', 'body[]'], { byUid: true })
    // await client.close()
    messages = [{ '#': 614, 'uid': 21798, 'body[]': 'Delivered-To: villa7.kluge5@gmail.com\r\nReceived: by 2002:ac2:43db:0:0:0:0:0 with SMTP id u27csp3431500lfl;\r\n        Sun, 23 Jun 2019 20:13:57 -0700 (PDT)\r\nX-Received: by 2002:a6b:2b08:: with SMTP id r8mr69208157ior.34.1561346037511;\r\n        Sun, 23 Jun 2019 20:13:57 -0700 (PDT)\r\nARC-Seal: i=2; a=rsa-sha256; t=1561346037; cv=pass;\r\n        d=google.com; s=arc-20160816;\r\n        b=DInee5vg+jok+gt2dJDIwLP9oZul3CkRVmT+PiscLz5jQWMLPr2Qd0efW5JnWmf6BY\r\n         aqUPoQt9taymGl5Wg8BZU+eTQPPenVp6reKJIq+It454m483gKEWwZp92XBVTvWX2A0y\r\n         JPESSRhM4Nfoqflk9QAdel9lIUJxvrxVAhfRKq0+jvyJkRivtYOP2X5uFfwRo0XB1cvY\r\n         apPOZoiTzTkVmW8NIBF/7d9VCQ5rBFrXU+ZcdUJQmHNjntos76/cfIdqJgO8K402zSBK\r\n         T6xBM9ngbb/m0aZKn/3X+5U2CKnphZ8//5IsB1M7HdVsxkWRKR/WercVn4dATMuINEQV\r\n         KjLQ==\r\nARC-Message-Signature: i=2; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;\r\n        h=to:subject:message-id:date:from:mime-version:dkim-signature\r\n         :delivered-to;\r\n        bh=Ij3Ia8i2So59x+ifHLrec+HtG69kHK12KBPmtDW4XYI=;\r\n        b=ex93OnmbAOeOgnTmPln+LHIbpOZN/gIkxfPD13hf5WJu0aq1qVAUX0NTTNJp/Sq+ao\r\n         ttqmbk19G0iGkSt2NPXsydD7t9nlwAR/Rfmn0kr/oTxCmFX1/+k1H+4sxIRKediVtIMM\r\n         seM9AdSDNr0IzxPtMDJcA9bjQBCQpjCZl5ICSroZQ1avoqO1IR0ghgQkxbt4oBJSavlz\r\n         DAcs5B/xXOH7V6km0Gt9SUaEs2ou60NTnZ++URXVKRGLcx85ISCM98YBIL4IihDRBPlc\r\n         fnJVvBBtJlLOJeXFn95AftBZCdM1JsIJAe7MKWJHj4kYIj3YDPeHmb7AVNE0E0Dxw0W7\r\n         iVfg==\r\nARC-Authentication-Results: i=2; mx.google.com;\r\n       dkim=pass header.i=@mindmeet-us.20150623.gappssmtp.com header.s=20150623 header.b=X5rz1nKp;\r\n       arc=pass (i=1 spf=pass spfdomain=mindmeet.us dkim=pass dkdomain=mindmeet-us.20150623.gappssmtp.com);\r\n       spf=pass (google.com: domain of theo+caf_=villa7.kluge5=gmail.com@mindmeet.us designates 209.85.220.41 as permitted sender) smtp.mailfrom="theo+caf_=villa7.kluge5=gmail.com@mindmeet.us"\r\nReturn-Path: <theo+caf_=villa7.kluge5=gmail.com@mindmeet.us>\r\nReceived: from mail-sor-f41.google.com (mail-sor-f41.google.com. [209.85.220.41])\r\n        by mx.google.com with SMTPS id e1sor6908670iom.44.2019.06.23.20.13.57\r\n        for <villa7.kluge5@gmail.com>\r\n        (Google Transport Security);\r\n        Sun, 23 Jun 2019 20:13:57 -0700 (PDT)\r\nReceived-SPF: pass (google.com: domain of theo+caf_=villa7.kluge5=gmail.com@mindmeet.us designates 209.85.220.41 as permitted sender) client-ip=209.85.220.41;\r\nAuthentication-Results: mx.google.com;\r\n       dkim=pass header.i=@mindmeet-us.20150623.gappssmtp.com header.s=20150623 header.b=X5rz1nKp;\r\n       arc=pass (i=1 spf=pass spfdomain=mindmeet.us dkim=pass dkdomain=mindmeet-us.20150623.gappssmtp.com);\r\n       spf=pass (google.com: domain of theo+caf_=villa7.kluge5=gmail.com@mindmeet.us designates 209.85.220.41 as permitted sender) smtp.mailfrom="theo+caf_=villa7.kluge5=gmail.com@mindmeet.us"\r\nX-Google-DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;\r\n        d=1e100.net; s=20161025;\r\n        h=x-gm-message-state:delivered-to:dkim-signature:mime-version:from\r\n         :date:message-id:subject:to;\r\n        bh=Ij3Ia8i2So59x+ifHLrec+HtG69kHK12KBPmtDW4XYI=;\r\n        b=gmXeWtGRxiPLxAgMYZNBMaqwSa1IxroArevkubnliJ0mpESOedJT9MkYkTpwutoUn6\r\n         hG8G5Bs3KRTYCesBHLEWLScETqWEIjXv3ziQOcY2IwJehyeB4M6rTTmZoFmjrNljcVl1\r\n         570afZi+S1JaGdBQdJa7RlTSCa/x/sUMigkbdFsFgv5DfiS1Iz/05OBKHmDrMZm1nPPn\r\n         I94+/v+dnnbj6Ja0Bqeu8925+TmkgbG3/iUAhnym/6z2m4rr5pYNRfaJLH25K5WvoJek\r\n         uZwZcyRxdb15+ADMFiC8hYZYiFVgyPRNtmzwg2Koat/Q9ZXabwSpBDZ57McpBHUIfq7W\r\n         oxYQ==\r\nX-Gm-Message-State: APjAAAXxl3Yt0ZtuSd2HYgbNonAEaAOkvbs4tf9FlACUSm/cbRGT8DbU\r\n\tOq5JbTSrMXZaVJimQciNsc8V1wGA4VHv4pI9nnjQUGO9VAJs4H1TKg==\r\nX-Received: by 2002:a5e:d615:: with SMTP id w21mr13201558iom.0.1561346036910;\r\n        Sun, 23 Jun 2019 20:13:56 -0700 (PDT)\r\nX-Forwarded-To: villa7.kluge5@gmail.com\r\nX-Forwarded-For: theo@mindmeet.us villa7.kluge5@gmail.com\r\nDelivered-To: theo@mindmeet.us\r\nReceived: by 2002:a05:6638:449:0:0:0:0 with SMTP id r9csp3389746jap;\r\n        Sun, 23 Jun 2019 20:13:55 -0700 (PDT)\r\nX-Received: by 2002:aed:39e7:: with SMTP id m94mr49689634qte.0.1561346035390;\r\n        Sun, 23 Jun 2019 20:13:55 -0700 (PDT)\r\nARC-Seal: i=1; a=rsa-sha256; t=1561346035; cv=none;\r\n        d=google.com; s=arc-20160816;\r\n        b=BziOGNiHs2TdN6BfmpcKFC1kJtXRBUKdwSLIOCi4+yFp3EmvqXJ7mFUNRs1z6VR/HN\r\n         HXrnxy8b3VWeiSAzpsoPwAXrxxvEPX2fCG0SYHiOVRTGYUnYb1ZL7nlCPKHquoSIAPyx\r\n         2vZ33zgi0sVkPCfvfjiLRPhnF08QAlGQ08d6uOIVE1c4Dvn4shlm+4vh+/476kPkwZgy\r\n         +51r9aglVLUnjGnCwd2lsSxD4gCWL5EXb8DF3Unc8Rs+ULboP2jEAANGfldQ6uppOpN1\r\n         DwqbExZcZWOn0+izNGHObkbk8XGPMe1gPFcp1L9AFgQrvPpxOCfz9k0tIZ9hGQuP5PND\r\n         l7Rg==\r\nARC-Message-Signature: i=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=arc-20160816;\r\n        h=to:subject:message-id:date:from:mime-version:dkim-signature;\r\n        bh=Ij3Ia8i2So59x+ifHLrec+HtG69kHK12KBPmtDW4XYI=;\r\n        b=yDnYAtWpKUWXQa0O2CZnUGihmq6yPgLGs8etiW0xGWsALlTdHE47ZndXZVFiwPN5Vr\r\n         4WTaT6K4qA383QTaiSsi2b0mPd5kwYevewFHC4LzN9MtiP1EL7Sh+DZCVq+3pRV3oajL\r\n         qW+55NNAfELlfHy/nqK2Qn1UiqsriD4oiiCwoZGG1sSBYwtJ9StROD4BoMADN1eZYvRQ\r\n         GZ/1qePL1vhPUgBp53TfP5Vv7ASVonIrFOk+I99ZTzq0/VM2tM5/wqoetJECNWebRuD9\r\n         e2RKcuZF1MWGJrhHp4UKaJQCsejkQv8jHYuQvq+qEpBNiIKGF2Mrawy9gyXB4ZnR1Oe8\r\n         KQRA==\r\nARC-Authentication-Results: i=1; mx.google.com;\r\n       dkim=pass header.i=@mindmeet-us.20150623.gappssmtp.com header.s=20150623 header.b=X5rz1nKp;\r\n       spf=pass (google.com: domain of connect@mindmeet.us designates 209.85.220.41 as permitted sender) smtp.mailfrom=connect@mindmeet.us\r\nReturn-Path: <connect@mindmeet.us>\r\nReceived: from mail-sor-f41.google.com (mail-sor-f41.google.com. [209.85.220.41])\r\n        by mx.google.com with SMTPS id z1sor5512142qkl.179.2019.06.23.20.13.54\r\n        for <theo@mindmeet.us>\r\n        (Google Transport Security);\r\n        Sun, 23 Jun 2019 20:13:55 -0700 (PDT)\r\nReceived-SPF: pass (google.com: domain of connect@mindmeet.us designates 209.85.220.41 as permitted sender) client-ip=209.85.220.41;\r\nDKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed;\r\n        d=mindmeet-us.20150623.gappssmtp.com; s=20150623;\r\n        h=mime-version:from:date:message-id:subject:to;\r\n        bh=Ij3Ia8i2So59x+ifHLrec+HtG69kHK12KBPmtDW4XYI=;\r\n        b=X5rz1nKp5jxclcbzcggqlWBHWcaDF8iA/EDDe8N4FjxHI3iLzbOWMRHxBF4z9wmyWr\r\n         ThLXnW3aj9BY5LYi8ZHl12fL+mIwrK99S2naw+AKgH3+kighH87JQYnArE2zpAX+IhCx\r\n         FZYbm9cstN6nirlPuhB/HPu09sp4fEcVvHDh24hpNY6yGfrRvWKyzb0TeAXyF6OFXoaH\r\n         t2xOu5aAfGI6cBHbJV/DeQRMXVhZ3e2SRuiZhe4sgLI0q3tsToT1+44llfg3hXzgzPW6\r\n         Avw9Vd3i3qI98hnc/cEhxfZncdIPhKoSnv3QuekSPrTbwf07/jzsR7/dmhbKutm12lkW\r\n         Pq8g==\r\nX-Google-Smtp-Source: APXvYqzcp42AvQHPbpvGvq1/6Du0q9OlxJQch5mBSvSF4N0UOnPLF46q8RYUSiAGQf3dE7MxN/Ithd7KzsxvWBRduZ8=\r\nX-Received: by 2002:a37:e30b:: with SMTP id y11mr103005175qki.100.1561346034415;\r\n Sun, 23 Jun 2019 20:13:54 -0700 (PDT)\r\nMIME-Version: 1.0\r\nFrom: The MindMeet Team <connect@mindmeet.us>\r\nDate: Mon, 24 Jun 2019 11:13:42 +0800\r\nMessage-ID: <CADHnOz9F3Vp1XA7rzUJ=DpQc6-TS0VGdnFKs6Apsjbb7cANTzw@mail.gmail.com>\r\nSubject: MindMeet Product Call\r\nTo: Theodore Kluge <theo@mindmeet.us>\r\nContent-Type: multipart/alternative; boundary="000000000000c0d452058c093334"\r\n\r\n--000000000000c0d452058c093334\r\nContent-Type: text/plain; charset="UTF-8"\r\n\r\nHello Theo,\r\n\r\nHope all is well. Can we move the scheduled meeting to 4pm tomorrow?\r\n\r\n-- \r\n\r\nWith Love & Magic <http://loveandmagic.company/>,\r\n\r\n*Nicole Serrano* | Director of Attention\r\n\r\nm +63 917 122 4296\r\n\r\n*MindMeet.*\r\n\r\nThe Social Knowledge Network for Good\r\n\r\n*www.mindmeet.us <http://www.mindmeet.us/>*\r\n\r\n--000000000000c0d452058c093334\r\nContent-Type: text/html; charset="UTF-8"\r\nContent-Transfer-Encoding: quoted-printable\r\n\r\n<div dir=3D"ltr">Hello=C2=A0Theo,<div><br></div><div>Hope all is well. Can =\r\nwe move the scheduled meeting to 4pm tomorrow?<br><div><div><br></div>-- <b=\r\nr><div dir=3D"ltr" class=3D"m_-5643025822950350977gmail_signature" data-sma=\r\nrtmail=3D"gmail_signature"><div dir=3D"ltr"><div><div dir=3D"ltr"><div dir=\r\n=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr=\r\n"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div =\r\ndir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"=\r\nltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><p style=3D"font-si=\r\nze:12.8px;padding:0px;margin:0px"></p><div style=3D"color:rgb(34,34,34);fon=\r\nt-family:Arial,Helvetica,sans-serif;font-size:small;font-style:normal;font-=\r\nweight:400;letter-spacing:normal;text-align:start;text-indent:0px;text-tran=\r\nsform:none;white-space:normal;word-spacing:0px"></div><p></p><div style=3D"=\r\ncolor:rgb(34,34,34);font-family:Arial,Helvetica,sans-serif;font-size:small;=\r\nfont-style:normal;font-weight:400;letter-spacing:normal;text-align:start;te=\r\nxt-indent:0px;text-transform:none;white-space:normal;word-spacing:0px"><div=\r\n dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D=\r\n"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><=\r\ndiv dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=3D"ltr"><div dir=\r\n=3D"ltr"><div dir=3D"ltr"><p style=3D"margin:0cm 0cm 0.0001pt;font-size:12p=\r\nt;font-family:Calibri,sans-serif"><span style=3D"font-family:&quot;Work San=\r\ns&quot;"><font size=3D"2">With=C2=A0<a href=3D"http://loveandmagic.company/=\r\n" style=3D"color:rgb(149,79,114);text-decoration:underline" target=3D"_blan=\r\nk"><span style=3D"text-decoration:none">Love &amp; Magic</span></a>,<span><=\r\n/span></font></span></p><p style=3D"margin:0cm 0cm 0.0001pt;font-size:12pt;=\r\nfont-family:Calibri,sans-serif"><span style=3D"font-family:&quot;Work Sans&=\r\nquot;"><font size=3D"2"><b>Nicole Serrano</b>=C2=A0| Director of Attention<=\r\nspan></span></font></span></p><p style=3D"margin:0cm 0cm 0.0001pt;font-size=\r\n:12pt;font-family:Calibri,sans-serif"><span style=3D"font-family:&quot;Work=\r\n Sans&quot;"><font size=3D"2">m +63 917 122 4296=C2=A0</font></span></p><p =\r\nstyle=3D"text-align:left;margin:0cm 0cm 0.0001pt;font-size:12pt;font-family=\r\n:Calibri,sans-serif"><span style=3D"font-family:&quot;Work Sans&quot;"><fon=\r\nt size=3D"2"><b>MindMeet.</b><span></span></font></span></p><p style=3D"tex=\r\nt-align:left;margin:0cm 0cm 0.0001pt;font-size:12pt;font-family:Calibri,san=\r\ns-serif"><span style=3D"font-family:&quot;Work Sans&quot;"><font size=3D"2"=\r\n>The Social Knowledge Network for Good</font></span></p><p style=3D"text-al=\r\nign:left;margin:0cm 0cm 0.0001pt;font-size:12pt;font-family:Calibri,sans-se=\r\nrif"><b style=3D"font-size:small;font-family:&quot;Work Sans&quot;;color:rg=\r\nb(149,79,114)"><a href=3D"http://www.mindmeet.us/" style=3D"color:rgb(149,7=\r\n9,114)" target=3D"_blank">www.mindmeet.us</a></b></p></div></div></div></di=\r\nv></div></div></div></div></div></div></div></div></div></div></div></div><=\r\np style=3D"font-size:12.8px;padding:0px;margin:0px;color:rgb(0,0,0)"><br></=\r\np><p style=3D"font-size:12.8px;padding:0px;margin:0px;color:rgb(0,0,0)"><im=\r\ng src=3D"https://docs.google.com/uc?export=3Ddownload&amp;id=3D1_TEaAxPn6rN=\r\nFffs5STQj62sdfBb0kKmw&amp;revid=3D0B3EF8L3dSA2COXJabzJmMVZVTkFVclRFbzZuMEpl=\r\nNTMyUlFJPQ" width=3D"96" height=3D"14"><br></p><p style=3D"font-size:12.8px=\r\n;padding:0px;margin:0px;color:rgb(0,0,0)"><img src=3D"https://docs.google.c=\r\nom/uc?export=3Ddownload&amp;id=3D13jOSY1kIp0vW4amatZHBIsdkvZ2nL8Cq&amp;revi=\r\nd=3D0B3EF8L3dSA2CRElSd3RvNUE2NUVRSVVqUi9rMzZ1YXp1ZGxJPQ" width=3D"96" heigh=\r\nt=3D"96"><br><br></p></div></div></div></div></div></div></div></div></div>=\r\n</div></div></div></div></div></div></div></div></div></div></div></div></d=\r\niv></div></div>\r\n\r\n--000000000000c0d452058c093334--\r\n' }]
    messages = await Promise.all(messages.map(async x => {
      return {
        uid: x.uid,
        body: await parseMime(x['body[]'])
      }
    }))
    res.json(messages)
  }
}
